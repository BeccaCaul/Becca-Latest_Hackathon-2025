# HomeBridgr Database Reference

HomeBridgr uses Supabase (Postgres + storage) for authentication, data, and user-generated assets. This document outlines the tables and expected columns that the current codebase reads or writes so you can validate migrations, craft policies, or seed data.

## Conventions

- All IDs are UUIDs generated by Supabase unless otherwise noted.
- Timestamps use `timestamptz` with a default of `now()` on insert.
- API routes use the service-role key (`SUPABASE_SERVICE_KEY`), so add Row Level Security before exposing routes publicly.
- JSON payloads are stored as `jsonb`.

## Tables

### profiles

Source of author metadata when enriching posts.

| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | Matches `auth.users.id`; primary key. |
| `display_name` | text | Display name shown in feeds. |
| `full_name` | text | Optional fallback for display name. |
| `username` | text | Used by `lib/api/posts.ts` when available. |
| `avatar_url` | text | Public URL to profile photo. |
| `bio` | text | Short bio surfaced in UI. |
| `hometown` | text | Used as "From" metadata. |
| `location` | text | Used as current location. |
| `is_in_home_circle` | boolean | Optional flag parsed by the frontend. |
| `created_at` | timestamptz | Standard Supabase timestamp. |

### student_posts

Primary feed data consumed by `/api/posts` and enriched with AI insights by `/api/posts/analyze`.

| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | Primary key. |
| `caption` | text | Required caption content. |
| `image_url` | text | Optional public URL to an uploaded image. |
| `author_id` | uuid | References `profiles.id` (or `auth.users.id`). |
| `created_at` | timestamptz | Ordering field for the feed. |
| `analysis_terms` | jsonb | Array of `{ term, explanation }` persisted after caption analysis. |
| `analysis_raw_text` | text | Raw JSON emitted by Bedrock. |
| `analysis_generated_at` | timestamptz | Timestamp when analysis was saved. |
| `location` | text | Optional city or venue label (frontend will fall back to author location). |
| `likes` | integer | Optional metric displayed in cards. |
| `comments` | integer | Optional metric displayed in cards. |

### communities

Created through `/api/community/create`.

| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | Primary key. |
| `name` | text | Required community name. |
| `slug` | text | Optional vanity slug. |
| `description` | text | Optional community description. |
| `created_by` | uuid | Creator user ID. |
| `created_at` | timestamptz | Defaults to `now()`. |

### community_members

Owner record inserted as part of community creation.

| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | Primary key. |
| `community_id` | uuid | References `communities.id`. |
| `member_id` | uuid | References the user joining the community. |
| `role` | text | `'owner'`, `'member'`, etc. Owner is inserted automatically today. |
| `created_at` | timestamptz | Defaults to `now()`. |

### community_posts

Created via `/api/community/post`.

| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | Primary key. |
| `community_id` | uuid | References `communities.id`. |
| `author_id` | uuid | References member/user ID. |
| `content_type` | text | Automatically set to `'text'`, `'link'`, or `'image'` when omitted. |
| `text_content` | text | Mutually exclusive with link/image fields; required if posting text. |
| `link_url` | text | Optional URL shared to the community. |
| `image_url` | text | Optional image URL. |
| `created_at` | timestamptz | Defaults to `now()`. |

### postcard_collections

Managed through `/api/collections`.

| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid | Primary key. |
| `name` | text | Required collection name. |
| `description` | text | Optional description. |
| `visibility` | text | Optional visibility enum (for example `private`, `shared`). |
| `created_by` | uuid | Owner user ID. |
| `created_at` | timestamptz | Defaults to `now()`. |

## Storage Buckets

| Bucket | Purpose | Access Notes |
| --- | --- | --- |
| `student_uploads` | Stores images uploaded from the post composer. | Must allow authenticated clients to upload and expose a public URL for consumption in the feed. |

## Relationships and Constraints

- `student_posts.author_id`, `communities.created_by`, `community_members.member_id`, and `community_posts.author_id` should all reference the canonical user ID (`profiles.id` or `auth.users.id`).
- `community_members.community_id` and `community_posts.community_id` reference `communities.id`.
- API routes assume cascading deletes are not enabled; cleanup logic currently issues explicit deletes when inserts fail (`/api/community/create`).

## Future Work

- Enable Row Level Security policies that allow creators to manage their own records and restrict read access as required.
- Add foreign key constraints if they do not already exist to ensure referential integrity.
- Consider indexes on `student_posts.created_at` and `community_posts.created_at` to maintain performant feeds.
